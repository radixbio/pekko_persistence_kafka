# Auto Serialization
**Last Updated:** *Jun 28, 2023*

## Authors and Maintainers
- Collin Gray

## Summary
The `AutoSerz` package is a utility which handles the automatic creation of `AvroSerializer` classes and HOCON 
serializer bindings for them. These two steps are handled by two separate rules, `generate_serializers` and
`generate_serializer_bindings` respectively, which allows for the bindings to either be generated from the automatically
generated serializers or from manually written serializers.

## Usage
There are two steps in order to use the `AutoSerz` package. 

### Step 1: Add the AutoSerz rules to your BUILD file

Load in the AutoSerz rules and use them to create the serializer and binding targets. The `generate_serializers` rule
takes as srcs all the source files containing classes you wish to serialize. The `generate_serializer_bindings` rule
takes as srcs all the source files containing both the classes which are serialized and the serializers themselves.

If bindings are to be created for classes which are serialized by the automatic serializers, then the 
`generate_serializer_bindings` rule must depend on the `generate_serializers` rule.

In the example below, `classes_to_serialize.scala` contains the classes which are to be serialized, and 
`manual_serializers.scala` contains hand-written serializers for some classes in `classes_to_serialize.scala`.

If there are bindings which must be written manually, then the `reference` argument of the `generate_serializer_bindings`
rule should be set to the path of the HOCON bindings file. Note that to avoid name collisions, the bindings file must not
be `resources/reference.conf`, as this must be the name of the bindings file generated by the rule.

In the example below, the `manual_bindings.conf` file contains the bindings for the hand-written bindings, which are
then combined with the automatically generated bindings.

```build
load("//shared/persistence:src/main/scala/autoserz/serializations.bzl", "generate_serializers")
load("//shared/persistence:src/main/scala/autoserz/serializations.bzl", "generate_serializer_bindings")

generate_serializers(
    name = "automatic-serializers",
    srcs = [
        "classes_to_serialize.scala",
    ],
)

generate_serializer_bindings(
    name = "automatic-serializer-bindings",
    srcs = [
        "classes_to_serialize.scala",
        "manual_serializers.scala",
        ":automatic-serializers",
    ],
    reference = "manual_bindings.conf",
)

scala_library(
    name = "serializers",
    srcs = [
        "classes_to_serialize.scala",
        "manual_serializers.scala",
        ":automatic-serializers",
    ],
    resources = [
        ":automatic-serializer-bindings",
    ],
)
```

### Step 2: Add the `@AutoSerz` annotation to classes you wish to serialize

Add the `@AutoSerz` annotation to any classes you wish to serialize. 

The annotation also takes flags, which are:
- `CachedImplicits`: This flag should be used if the class being serialized is used in the constructor of another class
which is also being serialized, as it will cache the implicit serializers for the class.
- `ExtendedActorSystem`: This flag should be used if the class being serialized contains an `ActorRef` or `StreamRef`

```scala
import org.apache.pekko.actor.typed.ActorRef
import com.radix.shared.persistence.autoserz.{AutoSerz, CachedImplicits, ExtendedActorSystem}

@AutoSerz
case class A()

@AutoSerz
sealed trait B
case object B1 extends B
case object B2 extends B

@AutoSerz(CachedImplicits)
case class C()

@AutoSerz(ExtendedActorSystem)
case class D(c: C, actorRef: ActorRef[C])

@AutoSerz
object E {
  case class E1()
  case class E2()
  case class E3()
}
```

## Other Notes
- `generate_serializers` uses all imports present in any source files passed to it, so if a particular class is relied
on frequently by the classes being serialized, it is recommended to import it in the source file.
- If you wish to view the output of either rule, you can add the `inspect = True` argument to the rule call, which will
  print the output to the console.
- Classes that contain generics will likely not be serializable using `AvroSerializer`, and so they must have a
handwritten serializer. (See the archetypes/transactions serializers for an example of this)
- You must only use one `generate_serializer_bindings` rule per package, as the rule generates `resources/reference.conf`,
which is the only allowed name for the HOCON bindings file. If you have multiple `generate_serializers` rules, simply
feed them all into one `generate_serializer_bindings` rule. (See the Archetypes BUILD file for an example of this)
- For a more realistic example of how to use the `AutoSerz` package, see the opentrons serializations package.